<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Status Update ‚Äî ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Kanit&family=Patrick+Hand&display=swap" rel="stylesheet">

  <style>
    body { background-color: #FFF5EE; font-family: 'Kanit', sans-serif; }

    h2 {
      font-family: 'Patrick Hand', cursive;
      font-size: 2.2rem;
      color: #FF8C94;
      text-align: center;
      margin-bottom: 20px;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.05);
    }
    h2::before, h2::after { content: "üåª"; font-size: 1.2rem; margin: 0 8px; }

    .search-btn {
      background-color: #FFB6B9;
      border: none;
      color: #fff;
      font-weight: 700;
      border-radius: 25px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: 0.25s;
    }
    .search-btn:hover { transform: scale(1.02); background-color: #FF9AA2; }

    .table-rounded {
      border-radius: 15px;
      overflow: hidden;
      border: 4px solid #FAC898;
      width: 100%;
      background-color: #FFEDD5;
    }

    .table-bordered { border-collapse: collapse; }
    .table-bordered th, .table-bordered td {
      border: 1px solid #ddd;
      text-align: center;
      vertical-align: middle;
      padding: 12px;
    }

    .table-rounded th { background-color: #FAD5A5; color: #000; font-weight: 700; }
    .table-rounded td { font-weight: 300; font-size: 1rem; }
    .table-rounded tbody tr:nth-child(odd) { background-color: #FFF2E1; }
    .table-rounded tbody tr:hover { background-color: #FFE9D0; }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 16px;
      font-weight: 600;
      font-size: 0.9rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      color: #fff;
    }

    .box-cute {
      border-radius: 16px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
      background-color: #FFF8F0;
      padding: 20px;
      border: 2px dashed #FDC5A5;
    }

    #statusBox {
      border: 3px solid #FAC898;
      padding: 20px;
      border-radius: 12px;
      background-color: #FFFAF0;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      font-weight: bold;
      color: #333;
      font-size: 0.99rem;
    }

    .log { white-space: pre-wrap; font-size: 0.9rem; color: #333; margin-top: 10px; }

    .preserve-newlines { white-space: pre-line; text-align: left; }

      .info-card {
    border: 3px solid #FAC898;
    background-color: #FFFAF0; /* warm pale background */
    padding: 18px;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    /* <-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á --> */
    color: #0f172a;          /* <- main text color (‡∏Ñ‡∏∏‡∏ì‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô) */
    font-weight: 600;
  }
  
  /* ‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
  .info-card p {
    margin: 6px 0;
    color: inherit;         /* ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö .info-card */
    font-weight: 600;
    line-height: 1.4;
    font-size: 0.95rem;
  }
  
  /* ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡πà‡∏ô (‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏≠‡∏∑‡πà‡∏ô‡∏ö‡∏≠‡∏Å‡πÑ‡∏î‡πâ) */
  .info-card a {
    color: #0b74de;
    text-decoration: underline;
  }
  
  /* ‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô/emoji ‡∏™‡∏µ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏≠‡∏ô‡∏ó‡∏£‡∏≤‡∏™‡∏ï‡πå‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° */
  .info-card .diamond { color: #E67300; margin-right:6px; }
  
  /* layout helpers (flex row) */
  .summary-row {
    display:flex;
    gap: 20px;
    align-items: stretch;
    flex-wrap:wrap;
  }
  .summary-row .col-box { flex:1 1 320px; min-width:260px; }

    @media (max-width: 767px) {
      .table-rounded td, .table-rounded th { padding: 10px; font-size: 0.95rem; }
    }
  </style>
</head>

<body class="container mt-4">

  <!-- Search UI -->
  <div class="row justify-content-center mb-4">
    <div class="col-12 col-md-8"
         style="border:4px solid #FAC898; padding:20px; border-radius:12px;
                background-color:#FFF8E1; box-shadow:0 4px 10px rgba(0,0,0,0.1);">

      <h2 class="text-center" style="font-weight:700; color:#FFA500; font-family:'Arial',sans-serif;">
        Status Update
      </h2>

      <div class="row justify-content-center mb-3">
        <div class="col-12 col-md-6">
          <input type="text" id="userId" class="form-control"
                 placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ account twitter (@username)"
                 style="text-align:center; border:none; padding:10px;">
        </div>
      </div>

      <div class="row justify-content-center mb-3">
        <div class="col-12 col-md-3">
          <button class="btn search-btn w-100" id="searchBtn"
                  style="border:none; padding:10px; background-color:#FAC898; color:#fff;
                         font-weight:bold;">
            Search
          </button>
        </div>
      </div>

      <div id="loading" class="text-center mt-3" style="display:none;">
        <div class="spinner-border text-success" role="status"></div>
        <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</p>
      </div>
    </div>
  </div>

  <div id="output"></div>
  <div id="log" class="log" style="display:none"></div>
<script>
/* =========== CONFIG =========== */
const SHEET_ID = '1ZW9e9rvH2yxJvnukUUKZTp2LzmPF87haxDL8r_rd-EM'; // data sheet id (keep as-is)
const DATA_SHEET_NAME = 'Sheet1';     // ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å (‡πÅ‡∏Å‡πâ‡∏ñ‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Sheet1)
const STATUS_SHEET_NAME = 'status ‡∏™‡∏µ'; // ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö mapping ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ => HEX color
/* ============================== */

/* --- Helpers --- */
function showLoading(show){ document.getElementById('loading').style.display = show ? 'block' : 'none'; }
// function showLog(msg){ const el=document.getElementById('log'); el.style.display='block'; el.textContent += msg + '\n'; }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function parseGVizText(text){
  const start = text.indexOf('{');
  const end = text.lastIndexOf('}');
  if(start === -1 || end === -1) throw new Error('Invalid gviz response');
  return JSON.parse(text.substring(start, end + 1));
}

/* pick readable text color based on background */
function pickTextColorOnBackground(bgColor) {
  if(!bgColor) return '#111';
  try {
    const s = (''+bgColor).trim();
    if(s.indexOf('rgba') === 0 || s.indexOf('rgb') === 0) {
      const nums = s.replace(/[^\d,\.]/g,'').split(',');
      const r = parseFloat(nums[0]), g = parseFloat(nums[1]), b = parseFloat(nums[2]);
      const yiq = (r*299 + g*587 + b*114)/1000;
      return yiq >= 128 ? '#111' : '#fff';
    }
    let c = s.replace('#','').trim();
    if(c.length === 3) c = c.split('').map(ch=>ch+ch).join('');
    if(c.length !== 6) return '#111';
    const r = parseInt(c.substr(0,2),16), g = parseInt(c.substr(2,2),16), b = parseInt(c.substr(4,2),16);
    const yiq = (r*299 + g*587 + b*114)/1000;
    return yiq >= 128 ? '#111' : '#fff';
  } catch(e){ return '#111'; }
}

/* --- Fetch gviz (no auth) --- */
async function fetchGviz(sheetName){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&tqx=out:json`;
  // Cache disabled for development
  const res = await fetch(url, { cache: 'no-store' });
  if(!res.ok) throw new Error('Network error: ' + res.status);
  const txt = await res.text();
  return parseGVizText(txt);
}

/* --- Convert gviz to simple arrays --- */
function gvizToArrayRows(g){
  const out = [];
  const cols = (g.table && g.table.cols) || [];
  const rows = (g.table && g.table.rows) || [];
  rows.forEach(r => {
    const rowArr = [];
    for(let i=0;i<cols.length;i++){
      rowArr.push(r.c && r.c[i] && typeof r.c[i].v !== 'undefined' ? r.c[i].v : '');
    }
    out.push(rowArr);
  });
  return { cols: cols.map(c => c.label || ''), rows: out };
}

/* --- Convert main data gviz into headers + rows objects --- */
function normalizeHeaders(cols){
  return cols.map(c => (c && c.label) ? c.label.toString().trim() : '');
}
function rowToObj(row, headers){
  const obj = {};
  for(let i=0;i<headers.length;i++){
    const key = headers[i] || ('col'+i);
    const cell = row.c && row.c[i] ? row.c[i].v : '';
    obj[key] = (cell === null || typeof cell === 'undefined') ? '' : String(cell);
  }
  return obj;
}
function buildRowsFromGvizObj(g){
  const headers = normalizeHeaders(g.table.cols || []);
  const rows = (g.table.rows || []).map(r => rowToObj(r, headers));
  return { headers, rows };
}

/* --- Build status color map from rows (robust) ---
   Accept rows array-of-arrays like:
   [ ['‡∏£‡∏≠‡∏Å‡∏î', '#FCE5CD'], ['‡∏Å‡∏î‡πÅ‡∏•‡πâ‡∏ß', '#C9DAF8'], ... ]
   Handles case when your sheet has no explicit header row.
*/
function buildStatusColorMapFromRows(rows){
  const map = {};
  if(!rows || !rows.length) return map;

  // Determine if first row looks like header: if first cell contains words like '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' or 'status'
  const first = (rows[0] && rows[0][0]) ? String(rows[0][0]).toLowerCase() : '';
  const maybeHeader = first.includes('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞') || first.includes('status') || first.includes('‡∏™‡∏µ');
  const start = maybeHeader ? 1 : 0;

  for(let i = start; i < rows.length; i++){
    const r = rows[i];
    if(!Array.isArray(r)) continue;
    const key = (r[0] || '').toString().trim();
    const color = (r[1] || '').toString().trim();
    if(!key) continue;
    if(!color) continue; // skip if no color set
    map[key] = color;
  }
  return map;
}

/* --- Find mapped color for statusText:
     1) exact (case-sensitive)
     2) exact case-insensitive
     3) substring match (case-insensitive) -> choose longest matching key
*/
function findMappedColorForStatus(statusText, statusColorMap){
  if(!statusText) return null;
  const txt = String(statusText).trim();
  if(!txt) return null;

  if(statusColorMap[txt]) return statusColorMap[txt];

  const lowerToKey = {};
  for(const k of Object.keys(statusColorMap)) lowerToKey[k.toLowerCase()] = k;
  if(lowerToKey[txt.toLowerCase()]) return statusColorMap[lowerToKey[txt.toLowerCase()]];

  // substring matches
  const matches = [];
  const low = txt.toLowerCase();
  for(const key of Object.keys(statusColorMap)){
    if(!key) continue;
    try {
      if(low.indexOf(key.toLowerCase()) !== -1) matches.push(key);
    } catch(e){ /* ignore */ }
  }
  if(matches.length === 0) return null;
  matches.sort((a,b) => b.length - a.length); // prefer longest
  return statusColorMap[matches[0]];
}

/* --- Render badge --- */
function renderStatusBadge(text, statusColorMap){
  if(!text) return '';
  const label = String(text).trim();
  const mapped = findMappedColorForStatus(label, statusColorMap);
  const bg = mapped || '#e6e6e6';
  const txtColor = pickTextColorOnBackground(bg);
  return `<span class="status-badge" style="background:${bg}; color:${txtColor}">${escapeHtml(label)}</span>`;
}

/* --- Render table and summary --- */
function renderResults(rows, headers, statusColorMap){
  showLoading(false);
  if(!rows || rows.length === 0){
    document.getElementById('output').innerHTML = `<div class="row justify-content-center"><div class="col-4"><div class='box-cute alert alert-warning text-center'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div></div></div>`;
    return;
  }

  // compute totals as before (defensive column names)
  let pickupTotal = 0, ecoShippingTotal = 0;
  rows.forEach(r => {
    const statusText = (r['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] || r['status'] || r['status_text'] || '').toString();
    if(statusText && statusText.indexOf('‡∏ñ‡∏∂‡∏á‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡πâ‡∏ß') !== -1){
      const sendBack = parseFloat((r['‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏ó‡∏¢'] || r['sendback'] || r['col5'] || '').toString().replace(/,/g,'')) || 0;
      const eco = parseFloat((r['‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏£'] || r['eco'] || r['col6'] || '').toString().replace(/,/g,'')) || 0;
      pickupTotal += sendBack;
      ecoShippingTotal += (sendBack + eco);
    }
  });

  const formatNumber = n => Math.round(n).toLocaleString('en-US');

  const summaryBox = `
  <div id="summaryStatusContainer" class="row justify-content-center mb-4">
    <div class="col-12">
      <div class="summary-row">
        <div class="col-box">
          <div class="info-card info-card--left text-center">
            <p style="font-weight:800; color:#0f172a; margin-bottom:8px;">‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á:</p>
            <p><span class="diamond">üî∏</span> ‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö/‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á: <span style="color:#E67300;">${formatNumber(pickupTotal)}</span> ‡∏ö‡∏≤‡∏ó</p>
            <p><span class="diamond">üî∏</span> ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏£ eco: <span style="color:#E67300;">${formatNumber(ecoShippingTotal)}</span> ‡∏ö‡∏≤‡∏ó</p>
            <p style="margin-top:8px; font-weight:600; color:#0f172a;">üìç ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° 15 ‡∏ö‡∏≤‡∏ó</p>
          </div>
        </div>

        <div class="col-box">
          <div class="info-card info-card--right">
            <p style="font-weight:800; color:#0f172a; margin-bottom:8px;">üíå ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡∏∞‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà</p>
            <p style="font-weight:700;">‡∏Å‡∏∏‡∏•‡∏¥‡∏™‡∏£‡∏≤ ‡∏à‡∏¥‡∏ô‡∏î‡∏≤</p>
            <p><span class="diamond">üî∂</span> ‡∏Å‡∏™‡∏¥‡∏Å‡∏£ (Kbank) 070-8-99869-9</p>
            <p style="margin-top:8px; font-weight:500; color:#0b74de;">
              ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏≠‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠-‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà-‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ ‡∏ú‡πà‡∏≤‡∏ô <a href="https://forms.gle/RisnJ8y8hFnL4d2Z7" target="_blank">‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ</a>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
`;


  // decide visible headers (robust: fallback to positions)
  const visibleHeaders = [
    headers[0] || 'col0',  // ‡πÅ‡∏≠‡∏Ñ
    headers[1] || 'col1',  // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
    headers[2] || 'col2',  // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    headers[3] || 'col3',  // ‡∏£‡∏≤‡∏Ñ‡∏≤
    headers[5] || 'col5',  // ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏ó‡∏¢
    headers[6] || 'col6',  // ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏£
    headers[10]|| 'col10', // ‡πÄ‡∏ß‡πá‡∏ö‡∏™‡πà‡∏á
    headers[8] || 'col8',  // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    headers[9] || 'col9'   // ‡πÄ‡∏•‡∏Ç‡πÅ‡∏ó‡∏£‡πá‡∏Ñ
  ];

  let table = `<table class="table table-bordered table-rounded"><thead><tr>
      <th class="text-center">‡πÅ‡∏≠‡∏Ñ</th>
      <th class="text-center">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
      <th class="text-center">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á</th>
      <th class="text-center">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å</th>
      <th class="text-center">‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏ó‡∏¢</th>
      <th class="text-center">‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏£</th>
      <th class="text-center">‡πÄ‡∏ß‡πá‡∏ö‡∏™‡πà‡∏á</th>
      <th class="text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á</th>
      <th class="text-center">‡πÄ‡∏•‡∏Ç‡πÅ‡∏ó‡∏£‡πá‡∏Ñ</th>
    </tr></thead><tbody>`;

    rows.forEach(r => {
      table += '<tr>';
      visibleHeaders.forEach((h, idx) => {
        const val = r[h] || '';
    
        if (idx === 7) {
          // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (badge)
          table += `<td class="text-center">${renderStatusBadge(val, statusColorMap)}</td>`;
          return;
        }
    
        if (idx === 2) {
          // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á" ‚Äî ‡πÅ‡∏™‡∏î‡∏á newlines ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏î‡πâ‡∏ß‡∏¢ escapeHtml)
          const safe = escapeHtml(val);
          table += `<td class="preserve-newlines">${safe}</td>`;
          return;
        }
    
        // ‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏Å‡∏ï‡∏¥
        table += `<td class="${idx === 2 ? 'text-start' : ''}">${escapeHtml(val)}</td>`;
      });
      table += '</tr>';
});

table += '</tbody></table>';
document.getElementById('output').innerHTML = summaryBox + table;
}
</script>
<script>
/* =========== Part 3: main handler + wiring + debug logs =========== */

async function handleSearch() {
  const uidRaw = (document.getElementById('userId').value || '').trim();
  if (!uidRaw) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ Twitter ‡∏Å‡πà‡∏≠‡∏ô');
    return;
  }
  const uid = uidRaw.toLowerCase();

  try {
    showLoading(true);
    document.getElementById('output').innerHTML = '';
    document.getElementById('log').style.display = 'none';
    document.getElementById('log').textContent = '';

    // Fetch both sheets in parallel
    console.log('Fetching data sheet:', DATA_SHEET_NAME, 'and status sheet:', STATUS_SHEET_NAME);
    const [dataG, statusG] = await Promise.all([
      fetchGviz(DATA_SHEET_NAME),
      fetchGviz(STATUS_SHEET_NAME)
    ]);

    // Build status color map
    const statusRows = gvizToArrayRows(statusG).rows; // array-of-arrays
    console.log('statusRows (raw):', statusRows);

    const statusColorMap = buildStatusColorMapFromRows(statusRows);
    console.log('statusColorMap:', statusColorMap);

    // Build data rows
    const { headers, rows } = buildRowsFromGvizObj(dataG);
    console.log('data headers:', headers);
    console.log('data rows count:', rows.length);

    // Filter rows by uid (robust candidates)
    const usernameCol = headers[0] || 'col0';
    const filtered = rows.filter(r => {
      const candidates = [
        (r[usernameCol] || ''),
        (r['account'] || r['user'] || r['username'] || r['‡πÅ‡∏≠‡∏Ñ'] || '')
      ];
      for (const c of candidates) {
        if (!c) continue;
        const s = String(c).trim().toLowerCase();
        if (s === uid) return true;
        if (s === ('@' + uid)) return true;
        if (('@' + s) === uid) return true;
      }
      return false;
    });

    console.log('filtered rows count:', filtered.length);

    // Render table
    renderResults(filtered, headers, statusColorMap);

  } catch (err) {
    console.error('handleSearch error', err);
    document.getElementById('output').innerHTML = `<div class='box-cute alert alert-danger text-center'>‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${escapeHtml(err && err.message ? err.message : err)}</div>`;
  } finally {
    showLoading(false);
  }
}

/* Wire events */
document.getElementById('searchBtn').addEventListener('click', handleSearch);
document.getElementById('userId').addEventListener('keydown', function(e){
  if (e.key === 'Enter') handleSearch();
});

/* Optional: prefill userId from query param (e.g. ?user=@zomday2) and auto-search */
(function autoPrefillFromQuery(){
  try {
    const params = new URLSearchParams(window.location.search);
    const q = params.get('user') || params.get('uid') || params.get('u');
    if (q) {
      document.getElementById('userId').value = q;
      // small delay so UI shows before running
      setTimeout(() => {
        handleSearch();
      }, 200);
    }
  } catch (e) { /* ignore */ }
})();
</script>

</body>
</html>
